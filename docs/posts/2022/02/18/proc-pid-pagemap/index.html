<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="毎日眠いです。">
    
    
    <link rel="shortcut icon" href="https://hanazonochateau.net/favicon.ico">
    
    
    <link rel="stylesheet" href="https://hanazonochateau.net/css/style.min.css">

    <title>/proc/$pid/pagemapを読みたいときにハマったポイント</title>

    <meta property="og:title" content="/proc/$pid/pagemapを読みたいときにハマったポイント" />
<meta property="og:description" content="linuxでは /proc/$pid/pagemap でプロセスの仮想メモリ領域がどのように物理メモリにマップされているかを調べることができます。 しかし、いくつか注意しないと正確に読めないのでそれについて解説します。
データはバイナリ形式で読み出す必要がある 普通に cat /proc/self/pagemap とかやっても読み出すことはできません。 このファイルはバイナリファイルで、ルールに従ってバイナリを読みださなければいけません。
ルールは pagemap.txt に書かれています。 8バイトずつ読み出します。 Bits 0-54が物理ページのフレーム番号です。
seekして正しい位置から読み出す 正しいオフセットから read しないといけません。 オフセットの計算は次のように行います。 仮想アドレスから物理アドレスを求めるから必要な部分を抜粋します。
unsigned long virt2phy(const void *virtaddr) { ... fd = open(&#34;/proc/self/pagemap&#34;, O_RDONLY); ... virt_pfn = (unsigned long)virtaddr / page_size; offset = sizeof(uint64_t) * virt_pfn; if (lseek(fd, offset, SEEK_SET) == (off_t) -1) { ... } retval = read(fd, &amp;page, PFN_MASK_SIZE); ... ... physaddr = ((page &amp; 0x7fffffffffffffULL) * page_size) &#43; ((unsigned long)virtaddr % page_size); return physaddr; } PFNというのはPage Frame Numberの頭文字っぽいです。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hanazonochateau.net/posts/2022/02/18/proc-pid-pagemap/" /><meta property="og:image" content="https://hanazonochateau.net/site_ogp.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-18T22:28:36+09:00" />
<meta property="article:modified_time" content="2022-02-18T22:28:36+09:00" />


    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://hanazonochateau.net/site_ogp.png"/>

<meta name="twitter:title" content="/proc/$pid/pagemapを読みたいときにハマったポイント"/>
<meta name="twitter:description" content="linuxでは /proc/$pid/pagemap でプロセスの仮想メモリ領域がどのように物理メモリにマップされているかを調べることができます。 しかし、いくつか注意しないと正確に読めないのでそれについて解説します。
データはバイナリ形式で読み出す必要がある 普通に cat /proc/self/pagemap とかやっても読み出すことはできません。 このファイルはバイナリファイルで、ルールに従ってバイナリを読みださなければいけません。
ルールは pagemap.txt に書かれています。 8バイトずつ読み出します。 Bits 0-54が物理ページのフレーム番号です。
seekして正しい位置から読み出す 正しいオフセットから read しないといけません。 オフセットの計算は次のように行います。 仮想アドレスから物理アドレスを求めるから必要な部分を抜粋します。
unsigned long virt2phy(const void *virtaddr) { ... fd = open(&#34;/proc/self/pagemap&#34;, O_RDONLY); ... virt_pfn = (unsigned long)virtaddr / page_size; offset = sizeof(uint64_t) * virt_pfn; if (lseek(fd, offset, SEEK_SET) == (off_t) -1) { ... } retval = read(fd, &amp;page, PFN_MASK_SIZE); ... ... physaddr = ((page &amp; 0x7fffffffffffffULL) * page_size) &#43; ((unsigned long)virtaddr % page_size); return physaddr; } PFNというのはPage Frame Numberの頭文字っぽいです。"/>

</head><body><header id="banner">
    <h2><a href="https://hanazonochateau.net/">花園シャトー107号室</a></h2>
    <nav>
        <ul>
            <li>
                <a href="https://hanazonochateau.net/posts" title="posts">posts</a>
            </li><li>
                <a href="https://hanazonochateau.net/575" title="575">575</a>
            </li><li>
                <a href="https://hanazonochateau.net/about" title="about">about</a>
            </li><li>
                <a href="https://hanazonochateau.net/comments" title="comments">comments</a>
            </li>
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>/proc/$pid/pagemapを読みたいときにハマったポイント</h1>
            <div>
                <time>February 18, 2022</time>
                </div>
    </header><p>linuxでは <code>/proc/$pid/pagemap</code> でプロセスの仮想メモリ領域がどのように物理メモリにマップされているかを調べることができます。
しかし、いくつか注意しないと正確に読めないのでそれについて解説します。</p>
<h1 id="データはバイナリ形式で読み出す必要がある">データはバイナリ形式で読み出す必要がある</h1>
<p>普通に <code>cat /proc/self/pagemap</code> とかやっても読み出すことはできません。
このファイルはバイナリファイルで、ルールに従ってバイナリを読みださなければいけません。</p>
<p>ルールは <a href="https://github.com/torvalds/linux/blob/v4.9/Documentation/vm/pagemap.txt"  target="_blank" >pagemap.txt</a> に書かれています。
8バイトずつ読み出します。
Bits 0-54が物理ページのフレーム番号です。</p>
<h1 id="seekして正しい位置から読み出す">seekして正しい位置から読み出す</h1>
<p>正しいオフセットから <code>read</code> しないといけません。
オフセットの計算は次のように行います。
<a href="https://mmi.hatenablog.com/entry/2017/05/01/215921"  target="_blank" >仮想アドレスから物理アドレスを求める</a>から必要な部分を抜粋します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">virt2phy</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">virtaddr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/proc/self/pagemap&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
    <span class="p">...</span>

    <span class="n">virt_pfn</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">virtaddr</span> <span class="o">/</span> <span class="n">page_size</span><span class="p">;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">virt_pfn</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">off_t</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="n">retval</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">,</span> <span class="n">PFN_MASK_SIZE</span><span class="p">);</span>
    <span class="p">...</span>

    <span class="p">...</span>
    <span class="n">physaddr</span> <span class="o">=</span> <span class="p">((</span><span class="n">page</span> <span class="o">&amp;</span> <span class="mh">0x7fffffffffffffULL</span><span class="p">)</span> <span class="o">*</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">virtaddr</span> <span class="o">%</span> <span class="n">page_size</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">physaddr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>PFNというのはPage Frame Numberの頭文字っぽいです。</p>
<h1 id="cap_sys_asmin-権限で読み出す"><code>CAP_SYS_ASMIN</code> 権限で読み出す</h1>
<p><code>sudo</code> しないと物理アドレスが入っているBits 0-54は0埋めされます。
<a href="https://github.com/torvalds/linux/blob/v4.9/Documentation/vm/pagemap.txt#L28"  target="_blank" >Reason: information about PFNs helps in exploiting Rowhammer vulnerability.</a>とあります、
Rowhammerアタックというやつですね。
まあ危ないんで気を付けて扱いましょう。</p>
</article>

        </main><footer id="footer" style="text-align: center;">
    <a href="https://forms.gle/Cc3R3fFMCQ9m6Rsr9" target="_blank">コメントはこちら</a>
    </br>
    Copyright © 2022 Totsugekitai
    </br>
    Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> and <a href="https://github.com/LukasJoswiak/etch"
        target="_blank">etch</a>
</footer></body>
</html>
